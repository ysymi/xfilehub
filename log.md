#### 6号下午
因为时间已经过去小一半了,感觉有点紧.

想好要做什么后,准备先去看看有没有什么最佳实践.好确定一下具体该怎么做。

总结下方案:

- 前端，利用html5的api，将文件分多份，每部分交给一个web work处理，每个线程分多次post,每次只post一个block，同时向主线程报告进度，
- 后端，调研tornado的异步非阻塞怎么利用，将文件写入到磁盘，同时应该有地方记录上传的状态，暂时和文件和用户关系存sqlite吧
暂时先这样吧 ，晚上回去撸一发代码

其实也要清楚，要想清楚再做，会更省时间


#### 6号晚上
先从前端入手，js是单线程的，但是要实现多线程还是有办法的，

- ajax 这个发出的请求是浏览器的线程 但回调还是js要处理 严格说不算js的多线程,但也是可以完成并发的
- web worker 这个貌似真的是有一个运行空间 去后台运行 ，这个空间是浏览器的开的js线程吧
- 回调 setTimeOut这种 还是单线程 只不过执行过程是异步的


#### 7号早上
前端暂时写完了，可以多线程向后端提交数据，现在在后端接文件还有好大问题，只有一两个请求会接受，但是大部分都500了，难道是给文件加锁了？

好吧 这里是自己写了一个bug 调了半天 浪费了一些时间
问题出在: 每个进程分片的位置用了绝对位置,但是没有用对. 所以每个线程只有一个block的位置是正确的,其他的都out of range了

接下来开始测试基本功能 发现换个文件 全都500了，这回是编码问题?
但是应该不用转码, blob本身就已经是二进制对象,读写的时候以二进制文件格式读写写的时候 就用二进制写就好

#### 7号晚上
写了个简易的进度展示，发现居然有大于100%的情况 而且 还不是固定的值.
打了日志发现，seq编号提交的有重复，但是后端是正确接收seq的，隐约觉得是闭包的坑


#### 8号早上，
果然是闭包的坑，之前只能看到成功返回的block编号只是某几个值，就好像经典的for循环里闭包没用好的症状，
但是奇怪的是 这个几个值并不是平均分布的，难道作用域交叉了？


#### 8号晚上
时间比较紧, 但是还是完成了几个小功能 上传进度 自动更新文件列表等
但是下载有个严重的bug 超过一个block size的文件,下载下来是乱码, 而且下载下来的文件比原始文件大一点点

bug的范围可以确定是在多个block拼接这里
debug发现 下载顺序按照seq 就不会有大小不一致的问题了
但是新问题又来了 一来一去 文件大小虽然一致 但是只要超过一个block的文件还是不能读写
还是拼接文件的问题

定位的时候 花了很多时间 去看别人怎么实现的 没有太关注自己的问题 等到冷静下来测试代码
才发现后台到前台传输的是没有问题的 是后台拼文件的方式有问题
但是好像别人也是这么做的啊， 如果不是这里有问题 那就只能是 前台分片传输到后台的问题了
先看看拼文件哪里不对吧

#### 9号下午
现在是前端传过来的blocks 可以合并成原文件 cat blocks > file
后端push 给 浏览器的文件 也是一致的 md5 服务端文件 == md5 下载文件
那问题就只有 在服务端合并文件了

花了好久才搞明白为什么,
真是个白痴问题，踩了个读取文件顺序问题的坑， block没有按顺序读取，
所以最后的文件 size是一样的 但是 内容不一样
其实也怪自己 保存index的时候 选项是sort-by-key 并没有将value sort 真是疏忽

#### 9号晚上
晚上往git里放了代码 但依旧碰到一个坑 之前有大文件的提交记录 计算历史的时候 用到了这些数据 超过git文件限制 不能上传
试了rebase 都不好使  但是在http://stackoverflow.com/a/2197616 这个answer里找到了答案 还不错 很顺利的解决了问题

#### 10号晚上
前端基本的功能也已经出来了 还在局域网用了一下呢 还有一个当初的设计没有实现 就是md5
早上查了下有什么方案算md5 如果要合并文件算总的md5 最后集中算可能风险比较大

还是薄利多销 每一个block算一个md5 只要每一个block的md5都正确,最后的文件肯定也是相同的但是最后, 除了会变麻烦一点
选了这个不太常规的方案 要算blob对象的方案 不是file 也不是 string 比较头疼 最后也还是转成了string
前端的任务变成了可能会IO重计算也重的地方, 先实现了再想办法改进吧


#### 11号晚上
加了md5的前端校验,导致上传前大概有一秒的延迟,而且很明显,考虑了一下要不要前端校验.
最后还是保留了,可以准备通过减小block size和加入动画,来掩饰这个延迟,这样可以安全性能有保障
